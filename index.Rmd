---
title: "Who is into Green Infrastructure"
author: "Sun Ho Hwang"
subtitle: Motivation of Green Infrastructure Participation
output: html_document
---


# Introduction

Due to global warming, one of the difficulties that the urban environment face is the increase of precipitation. There is a chance that this will lead to water pollution as the stormwater that runs through the urban impervious surface collects pollutants and enters the sewer system. There has been continuous effort to implement green infrastructure to adapt to this environmental change. However there are certain limits because this involves the voluntary participation of individual households. This study will help understand the motivation of the participants of the past rain barrel project and help guide environmental organizations to plan how to increase participation.

This project will analyze the motivation of households participating in the rain barrel project by comparing contributing factors which are the education attainment and median income at the census tract level. The education attainment and income of the people participating in this project will be represented as a map. Then the shapefile of the rain barrels will be overlapped in order to analyze the demographic characteristic of households participating in the project. 



# Materials and methods
```{r, message=F, warning=F}
library(acs)
install.packages("base")
library(choroplethr)
library(ggplot2)
library(choroplethrMaps)
library(ggmap)
#install.packages("mapproj")
library(mapproj)
library(maps)
library(tidycensus)
library(tidyverse)
library(kableExtra)
library(sf)
#knitr::opts_chunk$set(cache=TRUE)  # cache the results for quick compiling
```


```{r}

#register your api key

#census api key
census_api_key("de66b80e57fd740d87d1af03c5c306086b4f17fa")

#1. Rain Barrel Count per polygon

#download the rain barrel 2015 shapefile 

rb_2015<-st_read("C:/R_Project/RB1516/2015_completed_RBinstall.shp")

#pipe dataset to tibble

rb_2015_t = st_read("C:/R_Project/RB1516/2015_completed_RBinstall.shp") %>% as_tibble()

head(rb_2015_t)

#convert rb_2015 data in sf object

rb_sf <- rb_2015 %>%
  mutate_at(vars("Longitude", "Latitude"), as.numeric) %>%  
  st_as_sf(
    coords = c("Longitude", "Latitude"),
    agr = "constant",
    crs = 2262,        
    stringsAsFactors = FALSE,
    remove = TRUE)                 
                 
#census tract data, convert to same crs as rb data to move on spatial join

census_tract<-st_read("C:/R_Project/2015_CensusTract")

head(census_tract)                
                 
ct_new=st_transform(census_tract,st_crs(rb_sf))                 
                 
#join rain barrel in tract to count the rain barrels

rb_in_tract <- st_join(rb_sf, ct_new , join = st_within)
                 
#count rb's in tract

rb_tract_count <- count(as_tibble(rb_in_tract), GEOID) %>%
  print()

tract_rb_sf <- left_join(ct_new, rb_tract_count) %>%
  print()

tract_rb_sf
                 
map<-tract_rb_sf %>%
    ggplot() +
    geom_sf(aes(fill=n)) +
    scale_fill_gradient(low='red',high='green') +
    labs(title = 'Rain Barrels per Census Tract',
         fill = 'n',
         x=NULL, y=NULL) +  
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()) 

#Let's add education, income data and limit the map to Erie County

#Get the Census Data

View(load_variables(2015, "acs5", cache = TRUE))


get_vars = c('B07011_001',paste('B15003_',sprintf('%03d',c(1,17:25)),sep=''))

names(get_vars) =  c('income','all','hs','ged','some0','some1','as','bs','ms','prof','phd')

#limit to Erie County

acs_data = get_acs(geography = 'tract', variables = get_vars,state='NY',county='Erie',geometry='TRUE')

as_tibble(acs_data)

acs_spread = acs_data %>% 
    dplyr::select(-moe) %>% 
    spread(key=variable,value=estimate) %>%
    mutate('atleast_hs' = (hs + some0 + some1 + as + bs + ms + prof + phd) / all,
           'atleast_bs' = (bs + ms + prof + phd) / all,'atleast_ms' = (ms + prof + phd) / all) %>%
    dplyr::select(GEOID,income,atleast_hs,atleast_bs,atleast_ms)

#join acs data and rb data

#Census tract boundaries

#use GEOID

thm = theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(),
          axis.text.y = element_blank(), axis.ticks.y = element_blank())


#convert to same crs

acs_data_new=st_transform(acs_data,st_crs(tract_rb_sf))

#census tract boundary

tr = acs_data_new %>%
    st_intersection(tract_rb_sf) %>%
    group_by(NAME) %>%
    summarize() %>%
    ggplot() +
    labs(title = 'Census Tracts') + thm +
    geom_sf()

tr

#georeference

nb = st_read("C:/R_Project/ny_nb") %>%
    filter(City == 'Buffalo') %>%
    mutate(NEIGHBORHOOD = str_to_upper(Name)) %>%
    dplyr::select(NEIGHBORHOOD)

#same crs

nb_new=st_transform(nb_new,st_crs(tract_rb_sf))

#join

nb_final <- nb_new %>% st_join(tract_rb_sf,by='geometry') %>%dplyr::select(-moe) 

#I have everything on graph but have to spread

acs_spread_new = nb_final %>% 
    spread(key=variable,value=estimate) %>%
    mutate('atleast_hs' = (hs + some0 + some1 + as + bs + ms + prof + phd) / all,
           'atleast_bs' = (bs + ms + prof + phd) / all,'atleast_ms' = (ms + prof + phd) / all) %>%
    dplyr::select(geometry,GEOID.y,income,atleast_hs,atleast_bs,atleast_ms,n)

acs_spread_new[is.na(acs_spread_new)] <- 0

#rb map

rb_map<-acs_spread_new %>%
    ggplot() +
    geom_sf(aes(fill=n)) +
    scale_fill_gradient(low='red',high='green') +
    labs(title = 'Rain Barrel map',
         fill = 'n',
         x=NULL, y=NULL) +  
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank()) 

rb_map

#income_map

income_map = acs_spread_new %>% ggplot() + thm +
    labs(fill = 'Median\nIncome ($)') +
    scale_fill_gradient(low='red',high='green') +
    geom_sf(aes(fill=income))


income_map

#education_map

education_map_bs = acs_spread_new %>% ggplot() + thm +
    labs(fill = 'Education Attainment at least bachelor degree') +
    scale_fill_gradient(low='red',high='green') +
    geom_sf(aes(fill=atleast_bs))


education_map_bs

#scatterplot

scatterplot <- acs_spread_new %>%
    gather(key = 'var', value = 'val', income, atleast_bs) %>%
    mutate(var = recode(var, income = 'Income', atleast_bs = '% Bachelors')) %>%
    mutate(var = factor(var, levels=c('Income', '% Bachelors'))) %>%
    ggplot(aes(x = val, y = n)) +
    labs(y = 'rain barrels (n)',
         title = 'Income, education, and rain barrels') +
    theme(axis.title.x = element_blank()) +
    geom_point() +
    geom_smooth(method=lm) +
    facet_wrap(~var, ncol=2, scales='free')


scatterplot





















```




# Results

[~200 words]

Tables and figures (maps and other graphics) are carefully planned to convey the results of your analysis. Intense exploration and evidence of many trials and failures. The author looked at the data in many different ways before coming to the final presentation of the data.

Show tables, plots, etc. and describe them.


# Conclusions

[~200 words]

Clear summary adequately describing the results and putting them in context. Discussion of further questions and ways to continue investigation.

# References

All sources are cited in a consistent manner

#https://mattherman.info/blog/point-in-poly/
#https://kenkellner.com/blog/buffalo-recycle-part2.html
































